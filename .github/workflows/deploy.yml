name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, pdo, pdo_pgsql, redis, xml, curl, zip, bcmath

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: |
        composer install --prefer-dist --no-dev --optimize-autoloader
        npm ci

    - name: Build production assets
      run: |
        npm run build
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    - name: Run production tests
      env:
        APP_ENV: production
      run: |
        php artisan test --testsuite=Feature --stop-on-failure

    - name: Create deployment artifact
      run: |
        tar -czf deploy.tar.gz \
          --exclude=node_modules \
          --exclude=tests \
          --exclude=.git \
          --exclude=.github \
          --exclude=storage/logs/* \
          --exclude=storage/framework/cache/* \
          --exclude=storage/framework/sessions/* \
          --exclude=storage/framework/views/* \
          .

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: deployment-package
        path: deploy.tar.gz
        retention-days: 5

    # Add your deployment steps here
    # For example, deploying to a VPS, AWS, DigitalOcean, etc.
    # This is a placeholder for your specific deployment strategy
    
    - name: Deploy notification
      if: success()
      run: |
        echo "âœ… Deployment package created successfully!"
        echo "Version: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"